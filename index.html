<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Staff Login Form with SharePoint Integration & Token Authentication</title>
    <link href="https://unpkg.com/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://alcdn.msauth.net/browser/2.19.0/js/msal-browser.min.js"></script>
    <style>
        body {
            background-color: #f9fafb;
        }
        .container {
            max-width: 450px;
            margin: 40px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .error {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 4px;
        }
        .info {
            margin-top: 2rem;
            font-size: 0.875rem;
            color: #444444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-2xl font-semibold mb-4">Staff Token Form</h2>
        <button id="tokenBtn" class="mb-4 w-full p-2 bg-green-600 text-white rounded">
            Generate Token for SharePoint
        </button>
        <form id="staffForm" onsubmit="submitForm(event)" style="display:none;">
            <label>Name</label>
            <input type="text" id="name" class="w-full p-2 mb-4 border rounded" placeholder="Enter your name" required />

            <label>eMail</label>
            <input type="email" id="email" class="w-full p-2 mb-4 border rounded" placeholder="Enter your email" required />

            <label>Staff ID</label>
            <input type="text" id="staffID" class="w-full p-2 mb-4 border rounded" placeholder="Enter your staff ID" required />

            <label>Unit</label>
            <select id="unit" class="w-full p-2 mb-2 border rounded" onchange="toggleOtherUnit(this.value)" required>
                <option value="">Select Unit</option>
                <option value="INBOUND">INBOUND</option>
                <option value="OUTBOUND">OUTBOUND</option>
                <option value="SERVICE EXCELLENCE">SERVICE EXCELLENCE</option>
                <option value="SOCIAL MEDIA">SOCIAL MEDIA</option>
                <option value="DIGITAL SUPPORT">DIGITAL SUPPORT</option>
                <option value="OTHER">Other</option>
            </select>
            <input type="text" id="otherUnit" class="w-full p-2 mb-4 border rounded hidden" placeholder="Please specify other unit" />

            <label>Shift</label>
            <select id="shift" class="w-full p-2 mb-4 border rounded" required>
                <option value="">Select Shift</option>
                <option value="MORNING">MORNING</option>
                <option value="REGULAR">REGULAR</option>
                <option value="AFTERNOON">AFTERNOON</option>
                <option value="NIGHT">NIGHT</option>
            </select>

            <label>Token Type</label>
            <select id="tokenType" class="w-full p-2 mb-4 border rounded" required>
                <option value="">Select Token Type</option>
                <option value="ACCESS TOKEN">Access Token</option>
                <option value="ID TOKEN">ID Token</option>
            </select>

            <input type="hidden" id="latitude" />
            <input type="hidden" id="longitude" />

            <button type="submit" class="w-full p-2 bg-blue-600 text-white rounded">
                Submit and Continue
            </button>
            <p id="errorMessage" class="error"></p>
        </form>

        <div class="info">
            After submitting this form, your data will be saved in SharePoint.
        </div>
    </div>

    <script>
        const msalConfig = {
            auth: {
                clientId: "YOUR_CLIENT_ID",
                authority: "https://login.microsoftonline.com/YOUR_TENANT_ID",
                redirectUri: "https://agyirclarke.github.io"
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        const tokenBtn = document.getElementById('tokenBtn');
        const staffForm = document.getElementById('staffForm');
        const errorMessage = document.getElementById('errorMessage');

        const loginRequest = {
            scopes: ["https://5v73h7.sharepoint.com/.default"]
        };

        let account;

        tokenBtn.onclick = async () => {
            try {
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                account = loginResponse.account;
                msalInstance.setActiveAccount(account);
                tokenBtn.style.display = 'none';
                staffForm.style.display = 'block';
                errorMessage.textContent = '';
                getLocation();
            } catch (error) {
                console.error("Token generation failed:", error);
                errorMessage.textContent = 'Token generation failed. Please try again.';
            }
        };

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        document.getElementById('latitude').value = position.coords.latitude;
                        document.getElementById('longitude').value = position.coords.longitude;
                    },
                    () => {
                        errorMessage.textContent = "Location access denied. Please enable location services.";
                    }
                );
            } else {
                errorMessage.textContent = "Geolocation not supported by this browser.";
            }
        }
    </script>
</body>
</html>
